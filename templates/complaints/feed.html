<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Awaaz | Feed</title>
	<link rel="stylesheet" href="/static/css/dark.css" />
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0b0b0d] text-[#e6e6e6]">
	<div class="container max-w-5xl mx-auto px-4">
		<header class="flex items-center justify-between py-6">
			<h1 class="text-2xl font-semibold">üï≥Ô∏è Public Feed</h1>
			<div class="space-x-3 text-sm">
				<a class="text-blue-400 hover:text-blue-300" href="/new/">New Complaint</a>
				{% if is_admin %}
					<span class="text-zinc-400">|</span>
					<a class="text-red-400 hover:text-red-300" href="/admin/dashboard/">Admin Panel</a>
				{% endif %}
				{% if request.user.is_authenticated %}
					<span class="text-zinc-400">|</span>
					<span class="text-zinc-400">{{ request.user.username }}</span>
					<span class="text-zinc-400">|</span>
					<a class="text-blue-400 hover:text-blue-300" href="/logout/">Logout</a>
				{% else %}
					<span class="text-zinc-400">|</span>
					<a class="text-blue-400 hover:text-blue-300" href="/login/">Login</a>
					<span class="text-zinc-400">|</span>
					<a class="text-blue-400 hover:text-blue-300" href="/signup/">Sign up</a>
				{% endif %}
			</div>
		</header>
		<div class="card p-4 mb-6">
			<form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4">
				<div>
					<label class="block mb-2 text-zinc-300">Severity</label>
					<select name="severity" class="w-full rounded-md bg-[#0f0f14] border border-[#2a2a36] p-2">
						<option value="">Any</option>
						<option value="minor">Minor</option>
						<option value="moderate">Moderate</option>
						<option value="severe">Severe</option>
					</select>
				</div>
				<div>
					<label class="block mb-2 text-zinc-300">Location</label>
					<select name="location" class="w-full rounded-md bg-[#0f0f14] border border-[#2a2a36] p-2">
						<option value="">All Locations</option>
						{% for loc in locations %}
						<option value="{{ loc }}" {% if request.GET.location == loc %}selected{% endif %}>{{ loc }}</option>
						{% endfor %}
					</select>
				</div>
				<div class="md:col-span-2">
					<label class="block mb-2 text-zinc-300">Search</label>
					<input type="text" name="q" placeholder="Title, description, or location" class="w-full rounded-md bg-[#0f0f14] border border-[#2a2a36] p-2" value="{{ request.GET.q }}" />
				</div>
				<div>
					<label class="block mb-2 text-zinc-300">Sort</label>
					<select name="sort" class="w-full rounded-md bg-[#0f0f14] border border-[#2a2a36] p-2">
						<option value="new">Newest</option>
						<option value="top">Top (upvotes)</option>
					</select>
				</div>
				<div class="md:col-span-5 text-right">
					<button type="submit" class="inline-flex items-center rounded-md bg-blue-600 hover:bg-blue-500 px-4 py-2">Apply</button>
				</div>
			</form>
		</div>
		<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
			{% for item in items %}
				<div class="card p-3 relative">
					<a href="/complaint/{{ item.pk }}/"><img class="rounded-md" src="{{ item.image.url }}" /></a>
					<p class="mt-2">
						<strong class="text-lg">{{ item.title|default:"Pothole report" }}</strong>
						<br />
						<span class="badge {% if item.true_severity %}{{ item.true_severity }}{% else %}{{ item.predicted_severity }}{% endif %}">
							{% if item.true_severity %}{{ item.true_severity|capfirst }}{% else %}{{ item.predicted_severity|capfirst }}{% endif %}
						</span>
						<span class="text-zinc-400">‚Ä¢ Upvotes: {{ item.upvote_count }}</span>
					</p>
					{% if item.location %}
					<p class="text-blue-300 text-sm">üìç {{ item.location }}</p>
					{% endif %}
					<p class="text-zinc-300 text-sm">{{ item.description|default:"" }}</p>
					<p class="text-zinc-500 text-xs">By {{ item.user.username|default:"anonymous" }} ¬∑ {{ item.created_at }}</p>
					
					{% if is_admin %}
					<div class="absolute top-2 right-2">
						<button onclick="deleteComplaint({{ item.pk }})" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded" title="Delete complaint">
							üóëÔ∏è
						</button>
					</div>
					{% endif %}
				</div>
			{% empty %}
				<p>No complaints yet.</p>
			{% endfor %}
		</div>
		<div class="card p-3 mt-4 flex items-center justify-between">
			<div>
				{% if items.has_previous %}
					<a class="text-blue-400 hover:text-blue-300" href="?page={{ items.previous_page_number }}">Previous</a>
				{% endif %}
			</div>
			<div>Page {{ items.number }} of {{ items.paginator.num_pages }}</div>
			<div>
				{% if items.has_next %}
					<a class="text-blue-400 hover:text-blue-300" href="?page={{ items.next_page_number }}">Next</a>
				{% endif %}
			</div>
		</div>
	</div>

	<!-- Delete Confirmation Modal -->
	<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
		<div class="bg-[#0b0b0d] border border-[#2a2a36] rounded-lg p-6 max-w-md w-full mx-4">
			<h3 class="text-lg font-semibold text-red-400 mb-4">Confirm Deletion</h3>
			<p class="text-zinc-300 mb-6">Are you sure you want to delete this complaint? This action cannot be undone.</p>
			<div class="flex space-x-3">
				<button id="confirmDelete" class="flex-1 bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">Delete</button>
				<button id="cancelDelete" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
			</div>
		</div>
	</div>

	<!-- CSRF Token for AJAX requests -->
	{% csrf_token %}

	<script>
		let complaintToDelete = null;

		function deleteComplaint(complaintId) {
			complaintToDelete = complaintId;
			document.getElementById('deleteModal').classList.remove('hidden');
			document.getElementById('deleteModal').classList.add('flex');
		}

		document.getElementById('confirmDelete').addEventListener('click', function() {
			if (complaintToDelete) {
				fetch(`/complaint/${complaintToDelete}/delete/`, {
					method: 'POST',
					headers: {
						'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
						'Content-Type': 'application/json',
					}
				})
				.then(response => {
					if (response.ok) {
						location.reload();
					} else {
						alert('Error deleting complaint');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('Error deleting complaint');
				});
			}
		});

		document.getElementById('cancelDelete').addEventListener('click', function() {
			document.getElementById('deleteModal').classList.add('hidden');
			document.getElementById('deleteModal').classList.remove('flex');
			complaintToDelete = null;
		});

		// Close modal on outside click
		document.getElementById('deleteModal').addEventListener('click', function(e) {
			if (e.target === this) {
				document.getElementById('deleteModal').classList.add('hidden');
				document.getElementById('deleteModal').classList.remove('flex');
				complaintToDelete = null;
			}
		});
	</script>
</body>
</html>
