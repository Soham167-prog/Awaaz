<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Awaaz | Upload</title>
	<link rel="stylesheet" href="/static/css/dark.css" />
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#000000] text-[#f5f5f7]">
	<div class="container max-w-3xl mx-auto px-4">
		<header class="flex items-center justify-between py-6">
			<h1 class="text-2xl font-semibold">üï≥Ô∏è Awaaz - Pothole Report</h1>
			<div class="space-x-3 text-sm">
				<a class="text-blue-400 hover:text-blue-300" href="/">Feed</a>
				{% if request.user.is_authenticated %}
					<span class="text-zinc-400">|</span>
					<span class="text-zinc-400">{{ request.user.username }}</span>
					<span class="text-zinc-400">|</span>
					<a class="text-blue-400 hover:text-blue-300" href="/logout/">Logout</a>
				{% else %}
					<span class="text-zinc-400">|</span>
					<a class="text-blue-400 hover:text-blue-300" href="/login/">Login</a>
					<span class="text-zinc-400">|</span>
					<a class="text-blue-400 hover:text-blue-300" href="/signup/">Sign up</a>
				{% endif %}
			</div>
		</header>



		<div class="card p-6">
			<form method="post" enctype="multipart/form-data" class="space-y-4" id="uploadForm">
				{% csrf_token %}
				<div class="flex items-center gap-3">
					<label class="text-zinc-300">Public</label>
					{{ form.public }}
				</div>
				<div>
					<label class="block mb-2 text-zinc-300">Location</label>
					{{ form.location }}
				</div>
				<div>
					<label class="block mb-2 text-zinc-300">Road image</label>
					{{ form.image }}
				</div>
				<button type="submit" class="inline-flex items-center rounded-md bg-blue-600 hover:bg-blue-500 px-4 py-2" id="analyzeBtn">
					<span id="btnText">Analyze and Generate</span>
					<span id="loadingSpinner" class="hidden ml-2">
						<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
							<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
							<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
						</svg>
					</span>
				</button>
			</form>
		</div>

		<!-- Preview Section (hidden initially) -->
		<div id="previewSection" class="card p-6 mt-6 hidden">
			<h2 class="text-xl font-semibold mb-4">Review Your Post</h2>
			
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				<!-- Image Preview -->
				<div>
					<h3 class="text-lg font-medium mb-2">Image Preview</h3>
					<img id="imagePreview" class="w-full rounded-md border border-gray-600" alt="Uploaded image">
				</div>
				
			<!-- Analysis Results -->
			<div>
				<h3 class="text-lg font-medium mb-2">Analysis Results</h3>
				<div class="space-y-3">
					<div>
						<label class="block text-sm font-medium text-zinc-300">Severity</label>
						<span id="severityBadge" class="inline-block px-2 py-1 rounded text-sm font-medium"></span>
					</div>
					<div>
						<label class="block text-sm font-medium text-zinc-300">Confidence</label>
						<span id="confidenceText" class="text-sm"></span>
					</div>
					<div>
						<label class="block text-sm font-medium text-zinc-300">Location</label>
						<span id="locationText" class="text-sm text-blue-300"></span>
					</div>
				</div>
			</div>
			</div>

			<!-- Editable Content -->
			<div class="mt-6 space-y-4">
				<div>
					<label class="block text-sm font-medium text-zinc-300 mb-2">Title (Optional)</label>
					<input type="text" id="titleInput" class="w-full rounded-md bg-[#0f0f14] border border-[#2a2a36] p-2" placeholder="Enter a title for your complaint">
				</div>
				
				<div>
					<label class="block text-sm font-medium text-zinc-300 mb-2">Description (Optional)</label>
					<textarea id="descriptionInput" rows="3" class="w-full rounded-md bg-[#0f0f14] border border-[#2a2a36] p-2" placeholder="Add any additional details about the road condition"></textarea>
				</div>
				
				<div>
					<label class="block text-sm font-medium text-zinc-300 mb-2">Generated Text (You can edit this)</label>
					<textarea id="generatedTextInput" rows="4" class="w-full rounded-md bg-[#0f0f14] border border-[#2a2a36] p-2"></textarea>
				</div>
			</div>

			<!-- Action Buttons -->
			<div class="flex gap-3 mt-6">
				<button type="button" id="postBtn" class="inline-flex items-center rounded-md bg-green-600 hover:bg-green-500 px-4 py-2">
					Post to Feed
				</button>
				<button type="button" id="cancelBtn" class="inline-flex items-center rounded-md bg-gray-600 hover:bg-gray-500 px-4 py-2">
					Cancel
				</button>
			</div>
		</div>

		
	</div>

	<script>
		document.getElementById('uploadForm').addEventListener('submit', function(e) {
			e.preventDefault();
			
			const formData = new FormData(this);
			formData.append('action', 'analyze');
			const analyzeBtn = document.getElementById('analyzeBtn');
			const btnText = document.getElementById('btnText');
			const loadingSpinner = document.getElementById('loadingSpinner');
			
			// Show loading state
			analyzeBtn.disabled = true;
			btnText.textContent = 'Analyzing...';
			loadingSpinner.classList.remove('hidden');
			
			fetch('', {
				method: 'POST',
				body: formData,
				headers: {
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
				}
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					// Show preview with results
					showPreview(data);
				} else {
					alert('Error: ' + data.error);
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('An error occurred while processing the image.');
			})
			.finally(() => {
				// Reset button state
				analyzeBtn.disabled = false;
				btnText.textContent = 'Analyze and Generate';
				loadingSpinner.classList.add('hidden');
			});
		});

		function showPreview(data) {
			// Show image preview from the file input
			const fileInput = document.querySelector('input[type="file"]');
			if (fileInput.files[0]) {
				const imagePreview = document.getElementById('imagePreview');
				const reader = new FileReader();
				reader.onload = function(e) {
					imagePreview.src = e.target.result;
				};
				reader.readAsDataURL(fileInput.files[0]);
			}
			
			// Show severity
			const severityBadge = document.getElementById('severityBadge');
			severityBadge.textContent = data.severity.charAt(0).toUpperCase() + data.severity.slice(1);
			severityBadge.className = `inline-block px-2 py-1 rounded text-sm font-medium badge ${data.severity}`;
			
			// Show confidence
			document.getElementById('confidenceText').textContent = `${(data.confidence * 100).toFixed(1)}%`;
			
			// Show location
			const locationValue = document.querySelector('[name=location]').value;
			document.getElementById('locationText').textContent = locationValue || 'Not specified';
			
			// Show generated text
			document.getElementById('generatedTextInput').value = data.generated_text;
			
			// Show preview section
			document.getElementById('previewSection').classList.remove('hidden');
			
			// Store data for posting (without the file object)
			window.previewData = {
				severity: data.severity,
				confidence: data.confidence,
				generated_text: data.generated_text
			};
		}

			document.getElementById('postBtn').addEventListener('click', function() {
			// Get the original file from the form
			const fileInput = document.querySelector('input[type="file"]');
			if (!fileInput.files[0]) {
				alert('Please select an image first.');
				return;
			}
			
			const formData = new FormData();
			formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
			formData.append('action', 'post');
			formData.append('image', fileInput.files[0]);
			formData.append('public', document.querySelector('[name=public]').checked);
				formData.append('location', document.querySelector('[name=location]').value || '');
			formData.append('title', document.getElementById('titleInput').value);
			formData.append('description', document.getElementById('descriptionInput').value);
			formData.append('generated_text', document.getElementById('generatedTextInput').value);
			formData.append('predicted_severity', window.previewData.severity);
			formData.append('confidence', window.previewData.confidence);
			
			// Show loading state
			const postBtn = document.getElementById('postBtn');
			const originalText = postBtn.textContent;
			postBtn.disabled = true;
			postBtn.textContent = 'Posting...';
			
			fetch('', {
				method: 'POST',
				body: formData,
				headers: {
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
				}
			})
				.then(response => response.json())
				.then(data => {
					if (data.success && data.redirect_url) {
						window.location.href = data.redirect_url;
					} else {
						alert('Error posting to feed. Please try again.');
					}
				})
			.catch(error => {
				console.error('Error:', error);
				alert('An error occurred while posting. Please try again.');
			})
			.finally(() => {
				postBtn.disabled = false;
				postBtn.textContent = originalText;
			});
		});

		document.getElementById('cancelBtn').addEventListener('click', function() {
			document.getElementById('previewSection').classList.add('hidden');
			document.getElementById('uploadForm').reset();
			window.previewData = null;
		});
	</script>
</body>
</html>
